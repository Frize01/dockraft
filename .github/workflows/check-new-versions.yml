# .github/workflows/check-versions.yml
name: ðŸ” Check Minecraft Versions

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check all APIs
        id: check
        run: |
          if [ ! -f versions.json ]; then
            echo '{}' > versions.json
          fi

          CHANGES=""
          LAGGING=""
          MINOR_UPDATES=""
          HAS_NEW=false

          OLD_JSON=$(cat versions.json)

          compare() {
            local key="$1"
            local new_val="$2"
            local old_val
            old_val=$(echo "$OLD_JSON" | jq -r ".${key} // empty")

            if [ "$new_val" != "$old_val" ] && [ -n "$new_val" ]; then
              jq --arg k "$key" --arg v "$new_val" '.[$k] = $v' versions.json > versions.json.tmp
              mv versions.json.tmp versions.json
              HAS_NEW=true
            fi
          }

          # ============================================
          # 1. Vanilla & Snapshot
          # ============================================
          echo "::group::Checking Vanilla"
          MANIFEST=$(curl -fsSL https://piston-meta.mojang.com/mc/game/version_manifest_v2.json)
          VANILLA=$(echo "$MANIFEST" | jq -r '.latest.release')
          SNAPSHOT=$(echo "$MANIFEST" | jq -r '.latest.snapshot')
          OLD_VANILLA=$(echo "$OLD_JSON" | jq -r '.vanilla // empty')

          VANILLA_CHANGED=false
          if [ "$VANILLA" != "$OLD_VANILLA" ] && [ -n "$OLD_VANILLA" ]; then
            VANILLA_CHANGED=true
            echo "ðŸ†• Vanilla: ${OLD_VANILLA} â†’ ${VANILLA}"
          else
            echo "âœ… Vanilla inchangÃ©: ${VANILLA}"
          fi

          compare "vanilla"  "$VANILLA"
          compare "snapshot" "$SNAPSHOT"
          echo "::endgroup::"

          # ============================================
          # 2. Paper
          # ============================================
          echo "::group::Checking Paper"
          PAPER=""

          PAPER_BUILDS=$(curl -fsSL \
            "https://api.papermc.io/v2/projects/paper/versions/${VANILLA}/builds" 2>/dev/null || echo "{}")
          PAPER_BUILD=$(echo "$PAPER_BUILDS" | jq -r '.builds[-1].build // empty')

          if [ -n "$PAPER_BUILD" ]; then
            PAPER="${VANILLA}-build.${PAPER_BUILD}"
            if [ "$VANILLA_CHANGED" = true ]; then
              CHANGES="${CHANGES},paper"
            else
              MINOR_UPDATES="${MINOR_UPDATES},paper"
            fi
          else
            if [ "$VANILLA_CHANGED" = true ]; then
              LAGGING="${LAGGING},paper"
            fi
          fi

          compare "paper" "$PAPER"
          echo "::endgroup::"

          # ============================================
          # 3. Fabric
          # ============================================
          echo "::group::Checking Fabric"
          FABRIC_LOADER=$(curl -fsSL \
            "https://meta.fabricmc.net/v2/versions/loader" | jq -r '.[0].version // empty')

          FABRIC_GAME=$(curl -fsSL \
            "https://meta.fabricmc.net/v2/versions/game" | jq -r '[.[] | select(.stable==true)][0].version // empty')

          if [ -n "$FABRIC_LOADER" ]; then
            if [ "$FABRIC_GAME" = "$VANILLA" ]; then
              if [ "$VANILLA_CHANGED" = true ]; then
                CHANGES="${CHANGES},fabric"
              else
                MINOR_UPDATES="${MINOR_UPDATES},fabric"
              fi
            else
              if [ "$VANILLA_CHANGED" = true ]; then
                LAGGING="${LAGGING},fabric"
              fi
            fi
          fi

          compare "fabric" "$FABRIC_LOADER"
          echo "::endgroup::"

          # ============================================
          # 4. Forge
          # ============================================
          echo "::group::Checking Forge"
          FORGE=""

          FORGE_PROMOS=$(curl -fsSL \
            "https://files.minecraftforge.net/net/minecraftforge/forge/promotions_slim.json" 2>/dev/null || echo "{}")
          FORGE_REC=$(echo "$FORGE_PROMOS" | jq -r ".promos[\"${VANILLA}-recommended\"] // empty")
          FORGE_LAT=$(echo "$FORGE_PROMOS" | jq -r ".promos[\"${VANILLA}-latest\"] // empty")

          if [ -n "$FORGE_REC" ]; then
            FORGE="$FORGE_REC"
          elif [ -n "$FORGE_LAT" ]; then
            FORGE="$FORGE_LAT"
          fi

          if [ -n "$FORGE" ]; then
            if [ "$VANILLA_CHANGED" = true ]; then
              CHANGES="${CHANGES},forge"
            else
              MINOR_UPDATES="${MINOR_UPDATES},forge"
            fi
          else
            if [ "$VANILLA_CHANGED" = true ]; then
              LAGGING="${LAGGING},forge"
            fi
          fi

          compare "forge" "$FORGE"
          echo "::endgroup::"

          # ============================================
          # 5. NeoForge
          # ============================================
          echo "::group::Checking NeoForge"
          NEOFORGE=""

          MC_PARTS=(${VANILLA//./ })
          MC_MINOR="${MC_PARTS[1]:-0}"
          MC_PATCH="${MC_PARTS[2]:-0}"

          NEOFORGE_VERSIONS=$(curl -fsSL \
            "https://maven.neoforged.net/api/maven/versions/releases/net/neoforged/neoforge" 2>/dev/null || echo "{}")
          NEOFORGE=$(echo "$NEOFORGE_VERSIONS" | jq -r \
            --arg prefix "${MC_MINOR}.${MC_PATCH}." \
            '[.versions[] | select(startswith($prefix))] | last // empty')

          if [ -n "$NEOFORGE" ]; then
            if [ "$VANILLA_CHANGED" = true ]; then
              CHANGES="${CHANGES},neoforge"
            else
              MINOR_UPDATES="${MINOR_UPDATES},neoforge"
            fi
          else
            if [ "$VANILLA_CHANGED" = true ]; then
              LAGGING="${LAGGING},neoforge"
            fi
          fi

          compare "neoforge" "$NEOFORGE"
          echo "::endgroup::"

          # ============================================
          # 6. Spigot
          # ============================================
          echo "::group::Checking Spigot"
          SPIGOT=""

          SPIGOT_INFO=$(curl -fsSL \
            "https://hub.spigotmc.org/versions/${VANILLA}.json" 2>/dev/null || echo "{}")
          SPIGOT_REF=$(echo "$SPIGOT_INFO" | jq -r '.refs.Spigot // empty')

          if [ -n "$SPIGOT_REF" ]; then
            SPIGOT="${VANILLA}"
            if [ "$VANILLA_CHANGED" = true ]; then
              CHANGES="${CHANGES},spigot"
            else
              MINOR_UPDATES="${MINOR_UPDATES},spigot"
            fi
          else
            if [ "$VANILLA_CHANGED" = true ]; then
              LAGGING="${LAGGING},spigot"
            fi
          fi

          compare "spigot" "$SPIGOT"
          echo "::endgroup::"

          # ============================================
          # 7. Nettoyage des virgules
          # ============================================
          CHANGES=$(echo "$CHANGES" | sed 's/^,//')
          LAGGING=$(echo "$LAGGING" | sed 's/^,//')
          MINOR_UPDATES=$(echo "$MINOR_UPDATES" | sed 's/^,//')

          # ============================================
          # 8. RÃ©sumÃ© console
          # ============================================
          echo ""
          echo "========================================="
          echo "  RÃ‰SUMÃ‰"
          echo "========================================="
          echo "Vanilla       : ${VANILLA} (changed: ${VANILLA_CHANGED})"
          echo "Snapshot      : ${SNAPSHOT}"
          echo "Paper         : ${PAPER:-âŒ}"
          echo "Fabric        : ${FABRIC_LOADER:-âŒ}"
          echo "Forge         : ${FORGE:-âŒ}"
          echo "NeoForge      : ${NEOFORGE:-âŒ}"
          echo "Spigot        : ${SPIGOT:-âŒ}"
          echo "-----------------------------------------"
          echo "Changes       : ${CHANGES:-aucun}"
          echo "Lagging       : ${LAGGING:-aucun}"
          echo "Minor updates : ${MINOR_UPDATES:-aucun}"
          echo "========================================="

          # ============================================
          # 9. Outputs
          # ============================================
          {
            echo "has_new=${HAS_NEW}"
            echo "vanilla=${VANILLA}"
            echo "old_vanilla=${OLD_VANILLA}"
            echo "vanilla_changed=${VANILLA_CHANGED}"
            echo "changes=${CHANGES}"
            echo "lagging=${LAGGING}"
            echo "minor_updates=${MINOR_UPDATES}"
          } >> "$GITHUB_OUTPUT"

      # ============================================
      # Generate Summary
      # ============================================
      - name: Generate Summary
        if: steps.check.outputs.has_new == 'true'
        run: |
          VANILLA="${{ steps.check.outputs.vanilla }}"
          NEW_JSON=$(cat versions.json)
          KEYS="vanilla snapshot paper fabric forge neoforge spigot"

          {
            echo "## ðŸ” Minecraft Version Check"
            echo ""
            echo "| Loader | Version | Status |"
            echo "|--------|---------|--------|"
          } >> "$GITHUB_STEP_SUMMARY"

          for KEY in $KEYS; do
            NEW_V=$(echo "$NEW_JSON" | jq -r ".${KEY} // \"â€”\"")

            if echo ",${{ steps.check.outputs.changes }}," | grep -q ",${KEY},"; then
              STATUS="âœ… Mis Ã  jour"
            elif echo ",${{ steps.check.outputs.lagging }}," | grep -q ",${KEY},"; then
              STATUS="â³ Attend ${VANILLA}"
            elif echo ",${{ steps.check.outputs.minor_updates }}," | grep -q ",${KEY},"; then
              STATUS="ðŸ”§ Update mineur"
            else
              STATUS="â€” InchangÃ©"
            fi

            echo "| ${KEY} | \`${NEW_V}\` | ${STATUS} |" >> "$GITHUB_STEP_SUMMARY"
          done

      # ============================================
      # Create PR
      # ============================================
      - name: Create Pull Request
        if: steps.check.outputs.has_new == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ðŸ”„ Update versions.json"
          title: "ðŸ”„ Minecraft versions update"
          body: |
            Mise Ã  jour automatique des versions Minecraft.

            **Vanilla:** `${{ steps.check.outputs.vanilla }}`
            **Changes:** ${{ steps.check.outputs.changes }}
            **Lagging:** ${{ steps.check.outputs.lagging }}
            **Minor:** ${{ steps.check.outputs.minor_updates }}
          branch: auto/version-update
          labels: automated,versions

      # ============================================
      # Discord Notification
      # ============================================
      - name: Notify Discord
        if: steps.check.outputs.has_new == 'true'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "Pas de webhook configurÃ©, skip."
            exit 0
          fi

          VANILLA="${{ steps.check.outputs.vanilla }}"
          OLD_VANILLA="${{ steps.check.outputs.old_vanilla }}"
          VANILLA_CHANGED="${{ steps.check.outputs.vanilla_changed }}"

          if [ "$VANILLA_CHANGED" = "true" ]; then
            TITLE="ðŸ†• Nouvelle MC : ${OLD_VANILLA} â†’ ${VANILLA}"
            COLOR=16744448
          else
            TITLE="ðŸ”„ Update loaders Minecraft"
            COLOR=3447003
          fi

          # Construire les fields depuis versions.json
          FIELDS=$(jq '[to_entries[] | {name: .key, value: ("`" + .value + "`"), inline: true}]' versions.json)

          PAYLOAD=$(jq -n \
            --arg title "$TITLE" \
            --argjson color "$COLOR" \
            --argjson fields "$FIELDS" \
            --arg ts "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            '{
              embeds: [{
                title: $title,
                color: $color,
                fields: $fields,
                footer: {text: "MC Version Tracker"},
                timestamp: $ts
              }]
            }')

          curl -s -X POST "$DISCORD_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"

          echo "âœ… Notification Discord envoyÃ©e"
