# .github/workflows/check-versions.yml
name: üîç Check Minecraft Versions

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check all APIs
        id: check
        run: |
          if [ ! -f versions.json ]; then
            echo '{}' > versions.json
          fi

          CHANGES=""
          LAGGING=""
          MINOR_UPDATES=""
          HAS_NEW=false

          OLD_JSON=$(cat versions.json)

          # üí° NOUVELLE LOGIQUE : On ne d√©clenche et n'enregistre que les VRAIES diff√©rences
          check_status() {
            local key="$1"
            local new_val="$2"
            local old_val=$(echo "$OLD_JSON" | jq -r ".${key} // empty")

            if [ -z "$new_val" ]; then
              if [ "$VANILLA_CHANGED" = true ]; then
                LAGGING="${LAGGING},${key}"
              fi
            elif [ "$new_val" != "$old_val" ]; then
              if [ "$VANILLA_CHANGED" = true ]; then
                CHANGES="${CHANGES},${key}"
              else
                MINOR_UPDATES="${MINOR_UPDATES},${key}"
              fi
              jq --arg k "$key" --arg v "$new_val" '.[$k] = $v' versions.json > tmp.json && mv tmp.json versions.json
              HAS_NEW=true
            fi
          }

          # ============================================
          # 1. Vanilla & Snapshot
          # ============================================
          echo "::group::Checking Vanilla"
          MANIFEST=$(curl -fsSL https://piston-meta.mojang.com/mc/game/version_manifest_v2.json)
          VANILLA=$(echo "$MANIFEST" | jq -r '.latest.release // empty')
          SNAPSHOT=$(echo "$MANIFEST" | jq -r '.latest.snapshot // empty')
          OLD_VANILLA=$(echo "$OLD_JSON" | jq -r '.vanilla // empty')

          VANILLA_CHANGED=false
          if [ "$VANILLA" != "$OLD_VANILLA" ] && [ -n "$VANILLA" ]; then
            VANILLA_CHANGED=true
            echo "üÜï Vanilla: ${OLD_VANILLA} ‚Üí ${VANILLA}"
            CHANGES="${CHANGES},vanilla"
            jq --arg k "vanilla" --arg v "$VANILLA" '.["vanilla"] = $v' versions.json > tmp.json && mv tmp.json versions.json
            HAS_NEW=true
          else
            echo "‚úÖ Vanilla inchang√©: ${VANILLA}"
          fi

          check_status "snapshot" "$SNAPSHOT"
          echo "::endgroup::"

          # ============================================
          # 2. Paper
          # ============================================
          echo "::group::Checking Paper"
          PAPER=""
          PAPER_BUILDS=$(curl -fsSL "https://api.papermc.io/v2/projects/paper/versions/${VANILLA}/builds" 2>/dev/null || echo "{}")
          PAPER_BUILD=$(echo "$PAPER_BUILDS" | jq -r '.builds[-1]?.build // empty')

          if [ -n "$PAPER_BUILD" ]; then
            PAPER="${VANILLA}-build.${PAPER_BUILD}"
          fi

          check_status "paper" "$PAPER"
          echo "::endgroup::"

          # ============================================
          # 3. Fabric
          # ============================================
          echo "::group::Checking Fabric"
          FABRIC=""
          FABRIC_LOADER=$(curl -fsSL "https://meta.fabricmc.net/v2/versions/loader" | jq -r '.[0].version // empty')
          FABRIC_GAME=$(curl -fsSL "https://meta.fabricmc.net/v2/versions/game" | jq -r '[.[] | select(.stable==true)][0].version // empty')

          if [ -n "$FABRIC_LOADER" ] && [ "$FABRIC_GAME" = "$VANILLA" ]; then
            FABRIC="${VANILLA}-loader.${FABRIC_LOADER}"
          fi

          check_status "fabric" "$FABRIC"
          echo "::endgroup::"

          # ============================================
          # 4. Forge
          # ============================================
          echo "::group::Checking Forge"
          FORGE=""
          FORGE_PROMOS=$(curl -fsSL "https://files.minecraftforge.net/net/minecraftforge/forge/promotions_slim.json" 2>/dev/null || echo "{}")
          FORGE_REC=$(echo "$FORGE_PROMOS" | jq -r ".promos[\"${VANILLA}-recommended\"] // empty")
          FORGE_LAT=$(echo "$FORGE_PROMOS" | jq -r ".promos[\"${VANILLA}-latest\"] // empty")

          if [ -n "$FORGE_REC" ]; then
            FORGE="$FORGE_REC"
          elif [ -n "$FORGE_LAT" ]; then
            FORGE="$FORGE_LAT"
          fi

          check_status "forge" "$FORGE"
          echo "::endgroup::"

          # ============================================
          # 5. NeoForge
          # ============================================
          echo "::group::Checking NeoForge"
          NEOFORGE=""
          
          # On extrait "21" de "1.21.x"
          MC_PARTS=(${VANILLA//./ })
          MC_MINOR="${MC_PARTS[1]:-0}"

          NEOFORGE_VERSIONS=$(curl -fsSL "https://maven.neoforged.net/api/maven/versions/releases/net/neoforged/neoforge" 2>/dev/null || echo "{}")
          
          # Filtre avanc√© : Bonne branche ET uniquement des chiffres (pas de beta/snapshot)
          NEOFORGE=$(echo "$NEOFORGE_VERSIONS" | jq -r \
            --arg major "$MC_MINOR" \
            '[.versions[]? | select(startswith($major + ".") and test("^[0-9]+\\.[0-9]+\\.[0-9]+$"))] | sort_by(split(".") | map(tonumber)) | last // empty')

          check_status "neoforge" "$NEOFORGE"
          echo "::endgroup::"

          # ============================================
          # 6. Spigot
          # ============================================
          echo "::group::Checking Spigot"
          SPIGOT=""
          SPIGOT_INFO=$(curl -fsSL "https://hub.spigotmc.org/versions/${VANILLA}.json" 2>/dev/null || echo "{}")
          SPIGOT_REF=$(echo "$SPIGOT_INFO" | jq -r '.refs?.Spigot // empty')

          if [ -n "$SPIGOT_REF" ]; then
            # Ajoute le hash de commit pour d√©tecter les correctifs
            SPIGOT="${VANILLA}-$(echo "$SPIGOT_REF" | cut -c1-7)"
          fi

          check_status "spigot" "$SPIGOT"
          echo "::endgroup::"

          # ============================================
          # 7. Nettoyage des virgules
          # ============================================
          CHANGES=$(echo "$CHANGES" | sed 's/^,//')
          LAGGING=$(echo "$LAGGING" | sed 's/^,//')
          MINOR_UPDATES=$(echo "$MINOR_UPDATES" | sed 's/^,//')

          # ============================================
          # 8. R√©sum√© console
          # ============================================
          echo ""
          echo "========================================="
          echo "  R√âSUM√â"
          echo "========================================="
          echo "Vanilla       : ${VANILLA} (changed: ${VANILLA_CHANGED})"
          echo "Snapshot      : ${SNAPSHOT}"
          echo "Paper         : ${PAPER:-‚ùå}"
          echo "Fabric        : ${FABRIC:-‚ùå}"
          echo "Forge         : ${FORGE:-‚ùå}"
          echo "NeoForge      : ${NEOFORGE:-‚ùå}"
          echo "Spigot        : ${SPIGOT:-‚ùå}"
          echo "-----------------------------------------"
          echo "Changes       : ${CHANGES:-aucun}"
          echo "Lagging       : ${LAGGING:-aucun}"
          echo "Minor updates : ${MINOR_UPDATES:-aucun}"
          echo "========================================="

          # ============================================
          # 9. Outputs
          # ============================================
          {
            echo "has_new=${HAS_NEW}"
            echo "vanilla=${VANILLA}"
            echo "old_vanilla=${OLD_VANILLA}"
            echo "vanilla_changed=${VANILLA_CHANGED}"
            echo "changes=${CHANGES}"
            echo "lagging=${LAGGING}"
            echo "minor_updates=${MINOR_UPDATES}"
          } >> "$GITHUB_OUTPUT"

      # ============================================
      # Generate Summary
      # ============================================
      - name: Generate Summary
        if: steps.check.outputs.has_new == 'true'
        run: |
          VANILLA="${{ steps.check.outputs.vanilla }}"
          NEW_JSON=$(cat versions.json)
          KEYS="vanilla snapshot paper fabric forge neoforge spigot"

          {
            echo "## üîç Minecraft Version Check"
            echo ""
            echo "| Loader | Version | Status |"
            echo "|--------|---------|--------|"
          } >> "$GITHUB_STEP_SUMMARY"

          for KEY in $KEYS; do
            NEW_V=$(echo "$NEW_JSON" | jq -r ".${KEY} // \"‚Äî\"")

            if echo ",${{ steps.check.outputs.changes }}," | grep -q ",${KEY},"; then
              STATUS="‚úÖ Mis √† jour"
            elif echo ",${{ steps.check.outputs.lagging }}," | grep -q ",${KEY},"; then
              STATUS="‚è≥ Attend ${VANILLA}"
            elif echo ",${{ steps.check.outputs.minor_updates }}," | grep -q ",${KEY},"; then
              STATUS="üîß Update mineur"
            else
              STATUS="‚Äî Inchang√©"
            fi

            echo "| ${KEY} | \`${NEW_V}\` | ${STATUS} |" >> "$GITHUB_STEP_SUMMARY"
          done

      # ============================================
      # Create PR
      # ============================================
      - name: Create Pull Request
        if: steps.check.outputs.has_new == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "üîÑ Update versions.json"
          title: "üîÑ Minecraft versions update"
          body: |
            Mise √† jour automatique des versions Minecraft.

            **Vanilla:** `${{ steps.check.outputs.vanilla }}`
            **Changes:** ${{ steps.check.outputs.changes }}
            **Lagging:** ${{ steps.check.outputs.lagging }}
            **Minor:** ${{ steps.check.outputs.minor_updates }}
          branch: auto/version-update
          labels: automated,versions

      # ============================================
      # Discord Notification
      # ============================================
      - name: Notify Discord
        if: steps.check.outputs.has_new == 'true'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          VANILLA="${{ steps.check.outputs.vanilla }}"
          OLD_VANILLA="${{ steps.check.outputs.old_vanilla }}"
          VANILLA_CHANGED="${{ steps.check.outputs.vanilla_changed }}"
          CHANGES="${{ steps.check.outputs.changes }}"
          LAGGING="${{ steps.check.outputs.lagging }}"
          MINOR="${{ steps.check.outputs.minor_updates }}"

          NEW_JSON=$(cat versions.json)
          OLD_JSON=$(git show HEAD:versions.json 2>/dev/null || echo '{}')

          DESC_UPDATED=""
          DESC_LAGGING=""
          DESC_MINOR=""
          
          # Variable pour les sauts de ligne dans Discord
          NL=$'\n'

          # 1. On traite Vanilla en premier s'il a chang√©
          if [ "$VANILLA_CHANGED" = "true" ]; then
            DESC_UPDATED="‚Ä¢ \`vanilla\` : \`${OLD_VANILLA}\` ‚ûî \`${VANILLA}\`${NL}"
          fi

          # 2. On trie le reste dans les bonnes cat√©gories
          for KEY in paper fabric forge neoforge spigot snapshot; do
            NEW_V=$(echo "$NEW_JSON" | jq -r ".${KEY} // empty")
            OLD_V=$(echo "$OLD_JSON" | jq -r ".${KEY} // empty")
            
            [ -z "$OLD_V" ] && OLD_V="N/A"

            if echo ",$CHANGES," | grep -q ",$KEY,"; then
              DESC_UPDATED="${DESC_UPDATED}‚Ä¢ \`${KEY}\` : \`${OLD_V}\` ‚ûî \`${NEW_V}\`${NL}"
            elif echo ",$LAGGING," | grep -q ",$KEY,"; then
              DESC_LAGGING="${DESC_LAGGING}‚Ä¢ \`${KEY}\` : \`${OLD_V}\` *(attend ${VANILLA})*${NL}"
            elif echo ",$MINOR," | grep -q ",$KEY,"; then
              DESC_MINOR="${DESC_MINOR}‚Ä¢ \`${KEY}\` : \`${OLD_V}\` ‚ûî \`${NEW_V}\`${NL}"
            fi
          done

          # 3. Construction des blocs (Fields) Discord
          FIELDS="[]"

          if [ -n "$DESC_UPDATED" ]; then
            FIELD=$(jq -n --arg name "‚úÖ Mis √† jour" --arg value "$DESC_UPDATED" '{name: $name, value: $value, inline: false}')
            FIELDS=$(echo "$FIELDS" | jq --argjson f "$FIELD" '. + [$f]')
          fi

          DESCRIPTION=""
          if [ -n "$DESC_LAGGING" ]; then
            FIELD=$(jq -n --arg name "‚è≥ Pas encore sur ${VANILLA}" --arg value "$DESC_LAGGING" '{name: $name, value: $value, inline: false}')
            FIELDS=$(echo "$FIELDS" | jq --argjson f "$FIELD" '. + [$f]')
            DESCRIPTION="Certains loaders ne supportent pas encore ${VANILLA}."
          fi

          if [ -n "$DESC_MINOR" ]; then
            FIELD=$(jq -n --arg name "üîß Updates mineurs" --arg value "$DESC_MINOR" '{name: $name, value: $value, inline: false}')
            FIELDS=$(echo "$FIELDS" | jq --argjson f "$FIELD" '. + [$f]')
          fi

          # 4. Envoi final au Webhook
          if [ "$VANILLA_CHANGED" = "true" ]; then
            TITLE="üÜï Nouvelle MC : ${OLD_VANILLA} ‚ûî ${VANILLA}"
            COLOR=3447003
          else
            TITLE="üîÑ Update des loaders (Version ${VANILLA})"
            COLOR=10181046
          fi

          PAYLOAD=$(jq -n \
            --arg title "$TITLE" \
            --arg desc "$DESCRIPTION" \
            --argjson color "$COLOR" \
            --argjson fields "$FIELDS" \
            '{embeds: [{title: $title, description: $desc, color: $color, fields: $fields, footer: {text: "Minecraft Version Tracker ‚Ä¢ Re-check dans 6h"}}]}')

          curl -s -X POST "$DISCORD_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"